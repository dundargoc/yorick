#!/usr/bin/env fish

set uid (id -u)
set optional_binds

for device in /dev/{video,media,usb/hiddev}*
    set -a optional_binds --dev-bind $device $device
end

bwrap --unshare-all \
    --share-net \
    --new-session \
    --die-with-parent \
    --ro-bind /usr/ /usr/ \
    --ro-bind /etc /etc \
    --ro-bind /usr/share /usr/share \
    --dev /dev \
    --dev-bind /dev/dri /dev/dri \
    $optional_binds \
    --ro-bind /sys/dev/char /sys/dev/char \
    --ro-bind /sys/devices /sys/devices \
    --ro-bind /run/dbus /run/dbus \
    --perms 700 \
    --dir "/run/user/$uid" \
    --ro-bind "/run/user/$uid/wayland-0" "/run/user/$uid/wayland-0" \
    --ro-bind "/run/user/$uid/pipewire-0" "/run/user/$uid/pipewire-0" \
    --ro-bind "/run/user/$uid/pulse" "/run/user/$uid/pulse" \
    --ro-bind "/run/user/$uid/bus" "/run/user/$uid/bus" \
    --bind /opt/zoom /opt/zoom \
    --bind /opt/zoom/home $HOME \
    --symlink usr/bin /bin \
    --symlink usr/bin /sbin \
    --symlink usr/lib /lib \
    --symlink usr/lib /lib64 \
    --proc /proc \
    --tmpfs /tmp \
    --bind /tmp/.X11-unix/X0 /tmp/.X11-unix/X0 \
    --clearenv \
    --setenv SHELL $SHELL \
    --setenv USER $USER \
    --setenv QT_QPA_PLATFORM $QT_QPA_PLATFORM \
    --setenv QT_AUTO_SCREEN_SCALE_FACTOR $QT_AUTO_SCREEN_SCALE_FACTOR \
    --setenv QT_QPA_PLATFORMTHEME $QT_QPA_PLATFORMTHEME \
    --setenv DISPLAY $DISPLAY \
    --setenv TERM $TERM \
    --setenv DBUS_SESSION_BUS_ADDRESS $DBUS_SESSION_BUS_ADDRESS \
    --setenv DESKTOP_SESSION $DESKTOP_SESSION \
    --setenv GDMSESSION $GDMSESSION \
    --setenv GNOME_SETUP_DISPLAY $GNOME_SETUP_DISPLAY \
    --setenv XAUTHORITY $XAUTHORITY \
    --setenv LC_MONETARY $LC_MONETARY \
    --setenv LC_NUMERIC $LC_NUMERIC \
    --setenv LC_TIME $LC_TIME \
    --setenv LANG $LANG \
    --setenv HOME /opt/zoom/home \
    --setenv XDG_RUNTIME_DIR $XDG_RUNTIME_DIR \
    --setenv XDG_SESSION_TYPE $XDG_SESSION_TYPE \
    --setenv XDG_CURRENT_DESKTOP $XDG_CURRENT_DESKTOP \
    --setenv WAYLAND_DISPLAY $WAYLAND_DISPLAY \
    /opt/zoom/ZoomLauncher
